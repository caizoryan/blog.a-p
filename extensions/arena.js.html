
<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="/styles/style.css">
	
</head> 
<body>
	<pre>import {transform, attrs} from "../compile.js"

let host = "http://localhost:3000/api";
let auth = ''
let options = {
	headers: {
		Authorization: `Bearer ${auth}`,
		cache: "no-store",
		"Cache-Control": "max-age=0, no-cache",
		referrerPolicy: "no-referrer",
	},
};
const image = (block) => `&lt;img src="${block.image.display.url}" />`;
const media_embed = (block) =>
	`&lt;span class="media">${block.embed?.html}&lt;/span>`;

const media = (block) => `
	&lt;a href=${block?.source?.url}>
		&lt;div class="media">
			&lt;p class="title">${block.title}&lt;/p>
			&lt;img src="${block.image.display.url}" />
			&lt;p class="metadata">${block.source?.url}&lt;/p> 
		&lt;/div>
	&lt;/a>
`;

const video = (block) =>
	`&lt;video src=${block.attachment.url} controls loop>&lt;/video> `;
const link = (block) =>
	`&lt;span class="link"> &lt;a target="_blank" href=${block.source.url}>${block.title} ${link_svg}&lt;/a> &lt;/span>`;

const pdf = (block) => `
	&lt;a target="_blank" href=${block.attachment.url}>
		&lt;p class="pdf">
			&lt;span>
			${block.title} ${link_svg}
			&lt;/span>
			&lt;img src="${block.image.display.url}" />
		&lt;/p>
	&lt;/a>
`;

const fetch_json = (link, options) =>
	fetch(link, options).then((r) => r.json());
const get_channel = (slug) => {
	console.log("getting", slug)
	return fetch_json(host + "/channels/" + slug, options)
}
const get_block = (id) => fetch_json(host + "/blocks/" + id, options);
export default {
	condition: (item, child) => {
		return item.tag == 'a' &&
			(attrs(item).href.includes('are.na/block')
			 || attrs(item).href.includes('feed.a-p.space/blocks')
			)
	},
	element: async (item, child) => {
		let block = await get_block(attrs(item).href.split("/").pop().trim())
		if (block.class == 'Image') return image(block)
		// --------------------------------
		// Attachment
		// --------------------------------
		if (block.class == "Attachment") {
			if (block.attachment.extension == "mp4") {
				return video(block);
			} else if (block.attachment.extension == "pdf") {
				return pdf(block);
			}
		}

		// --------------------------------
		// Media
		// --------------------------------
		else if (block.class == "Media") {
			if (block.class == "Media" && block.embed) {
				return media_embed(block);
			}
			else return media(block);

		}

		// --------------------------------
		// Text
		// --------------------------------
		if (block.class == 'Text') {
			let transformed = await transform(block.content)
			if (child.trim().toLowerCase() == 'clip') return `&lt;div class='clip'>
&lt;a href='https://feed.a-p.space/' target="_blank">From [ FEED.A-P ]&lt;/a>
${transformed.slice(0,4).join("\n")}

&lt;a href='https://feed.a-p.space/blocks/${block.id}' target="_blank">
Read More
&lt;/a>
&lt;/div>`
		}
	}
}
</pre>
</body>
